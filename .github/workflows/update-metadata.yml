name: Update Metadata Anchors

on:
  push:
    paths:
      - 'characters/characters-README.md'
  workflow_dispatch:

jobs:
  update-metadata:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Update metadata block
        run: |
          FILE="characters/characters-README.md"

          TEMPLATE_LINE='<!-- character-template-source: templates/character-template.md -->'
          SCHEMA_LINE='<!-- validate-schema-source: schemas/validate-schema-character.yaml -->'

          # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸¡à¸µ metadata block à¸«à¸£à¸·à¸­à¸¢à¸±à¸‡
          if grep -q '<!--' "$FILE"; then
            # à¹à¸—à¸£à¸ anchor à¸–à¹‰à¸²à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ
            grep -q "$TEMPLATE_LINE" "$FILE" || sed -i "/-->/a $TEMPLATE_LINE" "$FILE"
            grep -q "$SCHEMA_LINE" "$FILE" || sed -i "/-->/a $SCHEMA_LINE" "$FILE"
          else
            echo "à¹„à¸¡à¹ˆà¸žà¸š metadata block à¹ƒà¸™ $FILE"
            exit 1
          fi

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add characters/characters-README.md
          git commit -m "ðŸ”§ Auto: Add metadata anchors to characters-README.md" || echo "No changes to commit"
          git push
